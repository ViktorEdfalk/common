<!--

    Copyright (C) 2013 Inera AB (http://www.inera.se)

    This file is part of Inera Certificate Modules (http://code.google.com/p/inera-certificate-modules).

    Inera Certificate Modules is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    Inera Certificate Modules is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

-->
<div class="header-fix-top">
  <div class="header-wrapper" ng-hide="widgetState.collapsedHeader" ng-animate="'menucollapse'">
    <div id="wcHeader" wc-header user="WC_CONTEXT" default-active="index">
    </div>
  </div>
  <div class="header-fix-panel">
    <div class="header-fix-top-expand">
      <div class="header-fix-top-expand-wrapper">
        <button class="btn btn-link" ng-click="toggleHeader()"><span ng-if="widgetState.collapsedHeader">Visa</span><span ng-if="!widgetState.collapsedHeader">Dölj</span> meny</button>
      </div>
    </div>
    <a class="backlink-icon" href="/web/dashboard#/create" title="Tillbaka till Skriv intyg"></a>

    <h1 style="display: inline-block; margin-right: 20px;"><span message key="ts.label.certtitle"></span></h1>

    <div class="inline-block">
      <label class="control-label">{{cert.patient.fullstandigtNamn}} - {{cert.patient.personid}}</label>
    </div>
    <div class="control-group buttonbar">
      <button class="btn btn-info" ng-click="save()">Spara</button>
      <button class="btn btn-secondary" ng-click="discard()">Ta bort utkast</button>
      <button class="btn btn-secondary" ng-if="!widgetState.showComplete && !isComplete" ng-click="toggleShowComplete()">Visa vad som behöver kompletteras
      </button>
      <button class="btn btn-secondary" ng-if="widgetState.showComplete && !isComplete" ng-click="toggleShowComplete()">
        Dölj vad som behöver kompletteras
      </button>
    </div>
    <div ng-show="certForm.$pristine && isComplete"><strong>Status:</strong> Intyget är sparat.</div>
    <div ng-show="certForm.$pristine && !isComplete"><strong>Status:</strong> Intyget är sparat, men inte komplett</div>
    <div ng-show="certForm.$dirty"><strong>Status:</strong> Intyget är <strong>inte</strong> sparat.</div>
  </div>
</div><!-- top end -->

<!-- TS-BAS -->
<div class="edit-form" ng-class="{'collapsed' : widgetState.collapsedHeader}">

  <form name="certForm" novalidate autocomplete="off">

    <div class="alert alert-error" ng-show="widgetState.showComplete && !isComplete" style="margin-right: 20px">
      <h3>Följande fält behöver kompletteras:</h3>
      <ul>
        <li ng-repeat="message in validationMessages"><span message key="{{message.message}}"></span></li>
      </ul>
    </div>

    <div id="certificate" class="row-fluid certificate">
      <div class="span12 cert-body">

        <div wc-field field-label="ts.label.intygavser">
          <div class="alert alert-error" ng-if="validationMessagesGrouped.intygavser">
            <ul>
              <li ng-repeat="message in validationMessagesGrouped.intygavser"><span message key="{{message.message}}"></span>
              </li>
            </ul>
          </div>

          <p>Information om Transportstyrelsens föreskrifter finns under länken Väg och sedan länken Trafikmedicin på <a href="http://www.transportstyrelsen.se" target="_blank">www.transportstyrelsen.se <img src="/img/link_icon.png"></a>.</p>

          <div class="control-group clearfix">
            <label class="checkbox checkbox-columns span3" ng-repeat="typ in cert.intygAvser.korkortstyp track by $index"><input id="typcheck{{$index}}" name="typcheck{{$index}}" type="checkbox" ng-model="typ.selected"> <span message key="ts.label.korkort.{{typ.type}}"></span></label>
          </div>
        </div>

        <div wc-field field-label="ts.label.identitet">
          <div class="alert alert-error" ng-if="validationMessagesGrouped.identitet">
            <ul>
              <li ng-repeat="message in validationMessagesGrouped.identitet"><span message key="{{message.message}}"></span>
              </li>
            </ul>
          </div>
          <div class="control-group clearfix">
            <label class="radio checkbox-columns span4" ng-repeat="(k,v) in form.identity"><input name="identity{{$index}}" type="radio" value="{{v}}" ng-model="cert.vardkontakt.idkontroll">
              {{k}}</label>
          </div>
        </div>

        <div class="alert alert-info">
          Läkaren ska uppmärksamma Transportstyrelsens föreskrifter och allmänna råd om medicinska krav för innehav av körkort m.m. (TSFS 2010:125, senast ändrade genom TSFS 2013:2). Intyget ska utfärdas i enlighet med vad som sägs i 17 kap. och får inte vara äldre än två månader när det inkommer till Transportstyrelsen. Se <a href="http://www.transportstyrelsen.se" target="_blank">www.transportstyrelsen.se <img src="/img/link_icon.png"></a>. Därefter "Väg" och "Trafikmedicin".
        </div>

        <!-- 1. Allmänt -->
        <div wc-field field-label="ts.label.allmant">
          <div class="control-group">
            <label for="diabetesyear"> Vilket år ställdes diagnosen diabetes?</label>
            <div class="controls">
              <input id="diabetesyear" type="text" maxlength="4" />
            </div>
          </div>
          <div class="control-group">
            Patienten har diabetes:
            <label class="radio"><input name="diabetestype1" type="radio" value="E11" ng-model="cert.diabetes.diabetesTyp">Typ 1</label>
            <label class="radio"><input name="diabetestype2" type="radio" value="E12" ng-model="cert.diabetes.diabetesTyp">Typ 2</label>
          </div>
          <div class="control-group">
            Behandling:
            <label class="checkbox"><input name="diabetestreat1" type="checkbox" ng-model="cert.diabetes.kost"> Kost</label>
            <label class="checkbox"><input name="diabetestreat2" type="checkbox" ng-model="cert.diabetes.tabletter"> Tabletter</label>
            <label class="checkbox"><input name="diabetestreat3" type="checkbox" ng-model="cert.diabetes.insulin"> Insulin</label>
          </div>
          <div class="control-group">
            <label for="diabetesyear"> Annan behandling, vilken? (ej obligatorisk)</label>
            <div class="controls">
              <input id="diabetesyear" type="text" ng-model="cert.allmant" wc-maxlength maxlength="53" />
            </div>
          </div>
        </div>

        <!-- 2. Hypoglykemier (lågt blodsocker)-->
        <div wc-field field-label="ts.label.hypoglykemier">
          <table class="table table-form">
            <tr>
              <th><span message key="common.yes"></span></th>
              <th><span message key="common.no"></span></th>
              <th class="maxwidth"></th>
            </tr>
            <tr>
              <td><input id="syney" name="syney" type="radio" ng-value="true" ng-model="cert.syn.nystagmus"></td>
              <td><input id="synen" name="synen" type="radio" ng-value="false" ng-model="cert.syn.nystagmus"></td>
              <td>a) Har patienten kunskap om lämpliga åtgärder vid hypoglykemi?</td>
            </tr>
            <tr>
              <td><input id="syney" name="syney" type="radio" ng-value="true" ng-model="cert.syn.nystagmus"></td>
              <td><input id="synen" name="synen" type="radio" ng-value="false" ng-model="cert.syn.nystagmus"></td>
              <td><p>b) Förekommer hypoglykemier med tecken på nedsatt hjärnfunktion (neuroglukopena symptom) som bedöms kunna innebära en trafiksäkerhetsrisk?</p>
                <p>(Om nej behöver c-e inte besvaras)</p></td>
            </tr>
            <tr>
              <td><input id="syney" name="syney" type="radio" ng-value="true" ng-model="cert.syn.nystagmus"></td>
              <td><input id="synen" name="synen" type="radio" ng-value="false" ng-model="cert.syn.nystagmus"></td>
              <td>c) Saknar patienten förmåga att känna varningstecken på hypoglykemi ("unawareness")?</td>
            </tr>
            <tr>
              <td><input id="syney" name="syney" type="radio" ng-value="true" ng-model="cert.syn.nystagmus"></td>
              <td><input id="synen" name="synen" type="radio" ng-value="false" ng-model="cert.syn.nystagmus"></td>
              <td>
                <p>d) Har patienten haft allvarlig hypoglykemi (som krävt hjälp av annan för att hävas) under det senaste året?</p>
                <label for="diabetesyear"> Hur många sådana episoder?</label>
                <div class="controls">
                  <input id="diabetesyear" type="text" ng-model="cert.syn.nystagmus" wc-maxlength maxlength="46" />
                </div>
              </td>
            </tr>
            <tr>
              <td><input id="syney" name="syney" type="radio" ng-value="true" ng-model="cert.syn.nystagmus"></td>
              <td><input id="synen" name="synen" type="radio" ng-value="false" ng-model="cert.syn.nystagmus"></td>
              <td><p>e) Har patienten haft allvarlig hypoglykemi i trafiken under det senaste året?</p>
                <label for="diabetesyear"> Hur många sådana episoder och när inträffade de?</label>
                <div class="controls">
                  <input id="diabetesyear" type="text" ng-model="cert.syn.nystagmus" wc-maxlength maxlength="40" />
                </div>
              </td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td><h5 class="inline-heading">För innehav av behörigheterna C1, C1E, C, CE, D1, D1E, D, DE och taxiförarlegitimation ska även fråga f-g besvaras</h5></td>
            </tr>
            <tr>
              <td><input id="syney" name="syney" type="radio" ng-value="true" ng-model="cert.syn.nystagmus"></td>
              <td><input id="synen" name="synen" type="radio" ng-value="false" ng-model="cert.syn.nystagmus"></td>
              <td>f) Genomför patienten egenkontroller av blodsocker?</td>
            </tr>
            <tr>
              <td><input id="syney" name="syney" type="radio" ng-value="true" ng-model="cert.syn.nystagmus"></td>
              <td><input id="synen" name="synen" type="radio" ng-value="false" ng-model="cert.syn.nystagmus"></td>
              <td>g) Har patienten haft allvarlig hypoglykemi (som krävt hjälp av annan för att hävas) under vaken tid det senaste året?</td>
            </tr>
          </table>
        </div>

        <!-- 3. Synintyg -->
        <div wc-field field-label="ts.label.synfunktioner" field-has-errors="testerror" ng-form name="synForm">

          <table class="table table-form">
            <tr ng-if="validationMessagesGrouped.syn">
              <td colspan="3"><div class="alert alert-error">
                <ul>
                  <li ng-repeat="message in validationMessagesGrouped.syn"><span message key="{{message.message}}"></span></li>
                </ul>
              </div></td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td><h5>Alternativ 1</h5></td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td>Vid synnedsättningar av betydelse för innehavet krävs ögonläkarintyg. Detta gäller vid proliferativ retinopati, genomgången laserbehandling av retinopati, signifikant makulaödem eller vid annan ögonsjukdom samt om ögonbottenfoto saknas.</td>
            </tr>
            <tr>
              <th><span message key="common.yes"></span></th>
              <th><span message key="common.no"></span></th>
              <th class="maxwidth"></th>
            </tr>
            <tr>
              <td><input id="synby" name="synby" type="radio" ng-value="true" ng-model="cert.syn.nattblindhet"></td>
              <td><input id="synbn" name="synbn" type="radio" ng-value="false" ng-model="cert.syn.nattblindhet"></td>
              <td>a. Ögonläkarintyg kommer att skickas in separat</td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td><h5 class="inline-heading">Alternativ 2: (frågorna b-d besvaras)</h5></td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td>Om ögonläkarintyg inte krävs kan behandlande specialistkompetent läkare med god kännedom om patientens sjukdom här avge intyg om synfunktionen.</td>
            </tr>
            <tr>
              <td><input id="syncy" name="syncy" type="radio" ng-value="true" ng-model="cert.syn.progressivOgonsjukdom"></td>
              <td><input id="syncn" name="syncn" type="radio" ng-value="false" ng-model="cert.syn.progressivOgonsjukdom"></td>
              <td>
                <p>b. Är synfältsprövning enligt Donders konfrontationsmetod utan anmärkning?</p>
              </td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td>
                <p>c. Synskärpa (alla bokstäver ska kunna läsas på den rad som anger synskärpan. Är synskärpan sämre än 0,1 ska den anges som 0,0).</p>
                <p>
                  Uppgifterna om synskärpa med och utan korrektion kan grundas på aktuellt intyg av bl.a. legitimerad optiker eller den som är anställd hos optiker. Alternativt kan kopia av sådant intyg bifogas. Uppgifter från ögonbottenfoto kan också användas.
                </p>

                <table class="table table-form">
                  <tr>
                    <th></th>
                    <th>Utan korrektion</th>
                    <th>Med korrektion</th>
                    <th>Kontaktlinser</th>
                  </tr>
                  <tr>
                    <td>Höger öga</td>
                    <td><input type="text" class="small-decimal" ng-model="cert.syn.hogerOga.utanKorrektion"></td>
                    <td><input type="text" class="small-decimal" ng-model="cert.syn.hogerOga.medKorrektion"></td>
                    <td><input type="checkbox" ng-model="cert.syn.hogerOga.kontaktlins"></td>
                  </tr>
                  <tr>
                    <td>Vänster öga</td>
                    <td><input type="text" class="small-decimal" ng-model="cert.syn.vansterOga.utanKorrektion"></td>
                    <td><input type="text" class="small-decimal" ng-model="cert.syn.vansterOga.medKorrektion"></td>
                    <td><input type="checkbox" ng-model="cert.syn.vansterOga.kontaktlins"></td>
                  </tr>
                  <tr>
                    <td>Binokulärt</td>
                    <td><input type="text" class="small-decimal" ng-model="cert.syn.binokulart.utanKorrektion"></td>
                    <td><input type="text" class="small-decimal" ng-model="cert.syn.binokulart.medKorrektion"></td>
                    <td></td>
                  </tr>
                </table>

            </tr>
            <tr>
              <td><input id="syney" name="syney" type="radio" ng-value="true" ng-model="cert.syn.nystagmus"></td>
              <td><input id="synen" name="synen" type="radio" ng-value="false" ng-model="cert.syn.nystagmus"></td>
              <td>d) Förekommer dubbelseende?</td>
            </tr>
          </table>
        </div>

        <!-- 4. Bedömning -->
        <div wc-field field-label="ts.label.bedomning">
          <div class="alert alert-error" ng-if="validationMessagesGrouped.bedomning">
            <ul>
              <li ng-repeat="message in validationMessagesGrouped.bedomning"><span message key="{{message.message}}"></span></li>
            </ul>
          </div>

          <table class="table table-form">
            <tr>
              <td></td>
              <td></td>
              <td>
                <p>Patienten uppfyller kraven enligt 6 kap. i Transportstyrelsens föreskrifter och allmänna råd om medicinska krav för innehav av körkort m.m. (TSFS 2010:125, senast ändrade genom TSFS 2013:2). Föreskrivna krav på läkarens specialistkompetens vid diabetessjukdom anges i 17 kap.
                   Se <a href="http://www.transportstyrelsen.se" target="_blank">www.transportstyrelsen.se <img src="/img/link_icon.png"></a>. Därefter "Väg" och "Trafikmedicin".</p>

                <div class="control-group">
                  <label class="radio"><input name="behorighetnagon" type="radio" ng-value="true" ng-model="form.behorighet"> Någon av följande behörigheter</label>
                  <div class="control-group clearfix indent" data-ng-show="form.behorighet">
                    <label class="checkbox checkbox-columns span3" ng-repeat="typ in cert.bedomning.korkortstyp track by $index"><input id="korkortstyp{{$index}}" name="korkortstyp{{$index}}" type="checkbox" ng-model="typ.selected"> <span message key="ts.label.korkort.{{typ.type}}"></span></label>
                  </div>
                  <label class="radio"><input name="behorighetinte" type="radio" ng-value="false" ng-model="form.behorighet"> Kan inte ta ställning</label>
                </div>
              </td>
            </tr>
            <tr>
              <th><span message key="common.yes"></span></th>
              <th><span message key="common.no"></span></th>
              <th class="maxwidth"></th>
            </tr>
            <tr>
              <td><input id="syney" name="syney" type="radio" ng-value="true" ng-model="cert.syn.nystagmus"></td>
              <td><input id="synen" name="synen" type="radio" ng-value="false" ng-model="cert.syn.nystagmus"></td>
              <td>Om patienten söker behörighet C1, C1E, C, CE, D1, D1E, D, DE eller Taxi, är han eller hon lämplig att inneha sådan behörighet med hänsyn till de körningar och arbetsformer som är aktuella vid sådant innehav? (Se 6 kap. 16 §)</td>
            </tr>
          </table>
        </div>

        <!-- Övriga upplysningar -->
        <div wc-field>
          <h5>Övriga upplysningar och kommentarer</h5>
          <textarea ng-model="cert.kommentar" wc-maxlength maxlength="10"></textarea>
        </div>

        <!-- Specialistkompetens -->
        <div wc-field>
          <h5>Patienten bör före ärendets avgörande undersökas av läkare med specialistkompetens i:</h5>
          <textarea name="specialist" rows='5' ng-model="cert.bedomning.lakareSpecialKompetens" wc-maxlength maxlength="{{inputLimits.lakareSpecialKompetens}}"></textarea>
        </div>

        <div class="body-row clearfix">
          <h3 class="title">
            <span message key="ts.label.unit"></span><span class="help">?</span>
          </h3>

          <div class="text">
            <div class="alert alert-error" ng-if="validationMessagesGrouped.vardenhet">
              <ul>
                <li ng-repeat="message in validationMessagesGrouped.vardenhet"><span message key="{{message.message}}"></span></li>
              </ul>
            </div>
            <label class="control-label">{{cert.skapadAv.vardenhet.enhetsnamn}} ({{cert.skapadAv.vardenhet.enhetsid}}), {{cert.skapadAv.vardenhet.vardgivare.vardgivarnamn}}</label>

            <div class="form-horizontal">
              <div class="control-group">
                <label class="control-label">Postadress</label>
                <div class="controls">
                  <input type="text" id="clinicInfo.postalAddress" name="clinicInfo.postalAddress" ng-model="cert.skapadAv.vardenhet.postadress">
                </div>
              </div>
              <div class="control-group">
                <label class="control-label">Postnummer</label>
                <div class="controls">
                  <input type="text" id="clinicInfo.postalCode" name="clinicInfo.postalCode" ng-model="cert.skapadAv.vardenhet.postnummer">
                </div>
              </div>
              <div class="control-group">
                <label class="control-label">Postort</label>
                <div class="controls">
                  <input type="text" id="clinicInfo.postalCity" name="clinicInfo.postalCity" ng-model="cert.skapadAv.vardenhet.postort">
                </div>
              </div>
              <div class="control-group">
                <label class="control-label">Telefonnummer</label>
                <div class="controls">
                  <input type="text" id="clinicInfo.phone" name="clinicInfo.phone" ng-model="cert.skapadAv.vardenhet.telefonnummer">
                </div>
              </div>
              <div class="control-group" ng-if="false">
                <label class="control-label">Epost</label>
                <div class="controls">
                  <input type="text" id="clinicInfo.email" name="clinicInfo.email" ng-model="mats.ekhammar@callistaenterprise.se">
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
      <!-- cert body -->

    </div>
    <!-- certificate -->

    <p>Specialistkompetens i:</p>

    <div ng-repeat="spec in cert.skapadAv.specialiteter">
      {{spec}}
    </div>

    <button class="btn btn-success" ng-disabled="!isComplete">Signera intyget och skicka direkt till
      Transportstyrelsen
    </button>
  </form>
</div>
